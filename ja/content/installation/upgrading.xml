<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
  "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">

<section id="upgrading">
    <title>OTRS の 3.3 から 4 へのアップグレード</title>

    <para>
    これらの手順は、OTRSを<emphasis>3.3</emphasis>から<emphasis>4</emphasis>へアップグレード、及び<emphasis>4</emphasis>以降のパッチレベルリリースの<emphasis>4</emphasis>へアップグレードする人々に向けた説明です。RPMとソースコード(tarball)のアップグレードの両方に適用されます。
    </para>

    <para>
    あなたがOTRSの下位バージョンを実行している場合は、3.3の最初の(1.1->1.2->1.3->2.0->2.1->2.2->2.3->2.4>3.0->3.1->3.2->3.3)アップグレードパスに従わなければなりません！
あなたは、データベースの変更とアップグレードのperlスクリプトを含む、その間のすべてのバージョンへの完全アップグレードを実行する必要があります。
    </para>

    <para>
    OTRS2.2またはそれ以前からアップグレードする場合、あなたは<ulink
url="http://bugs.otrs.org/show_bug.cgi?id=6798">余分なステップ</ulink>を取らなければならないことに注意してください。
    </para>

    <para>
    単一のマイナーバージョンの中で、あなたがアップグレードする場合、パッチレベルリリースをスキップすることができます。あなたは、このような「パッチレベルのアップグレード」を行う必要がある場合たとえば、あなたは手順6、11、13および14をスキップする必要があり、バージョン4パッチレベル6に直接OTRS4パッチレベル2からアップグレードすることができます。
    </para>

    <para>
    最初に独立した試験機でのテスト·アップデートを実行することを強くお勧めします。
    </para>

    <section role="NotInToc">
        <title>Step 1: 関連するすべてのサービスを停止します。</title>

        <para>
        OTRSにアクセスしようとする複数の実行中のサービスやcronジョブがないことを確認してください。これはあなたのサービスの構成に依存し、これは一例です。<screen><![CDATA[
shell> /etc/init.d/cron stop
shell> /etc/init.d/postfix stop
shell> /etc/init.d/apache stop
            ]]></screen> OTRS cronジョブとスケジューラを(この順序で)停止します。<screen><![CDATA[
shell> cd /opt/otrs/
shell> bin/Cron.sh stop
shell> bin/otrs.Scheduler.pl -a stop
            ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 2: <filename>/opt/otrs/</filename> 配下の全てをバックアップしてください。</title>

        <para>
            <itemizedlist>
                <listitem><para><filename>Kernel/Config.pm</filename></para></listitem>
                <listitem><para><filename>Kernel/Config/GenericAgent.pm</filename></para></listitem>
                <listitem><para><filename>Kernel/Config/Files/ZZZAuto.pm</filename></para></listitem>
                <listitem><para><filename>var/*</filename></para></listitem>
                <listitem><para>データベースも同様に行います。</para></listitem>
            </itemizedlist>
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 3: 全てを確実にバックアップしたことを確認してください。 ;-)</title>
        <para></para>
    </section>

    <section role="NotInToc">
    <title>Step 4: 新しいリリースをインストールします。 (tar や RPM)</title>

        <section role="NotInToc">
        <title>Step 4.1: tarball を使う場合:</title>

            <screen><![CDATA[
shell> cd /opt
shell> mv otrs otrs-old
shell> tar -xzf otrs-x.x.x.tar.gz
shell> mv otrs-x.x.x otrs
            ]]></screen>

            <section role="NotInToc">
            <title>旧構成ファイルをリストア</title>

                <para>
                    <itemizedlist>
                        <listitem><para><filename>Kernel/Config.pm</filename></para></listitem>
                        <listitem><para><filename>Kernel/Config/GenericAgent.pm</filename></para></listitem>
                        <listitem><para><filename>Kernel/Config/Files/ZZZAuto.pm</filename></para></listitem>
                    </itemizedlist>
                </para>
            </section>

            <section role="NotInToc">
                <title>TicketCounter.logをリストア</title>

                <para>
                    In order to let OTRS continue with the correct ticket number, restore the
<filename>TicketCounter.log</filename> to
<filename>/opt/otrs/var/log/</filename>. This is especially important if you
use incremental ticketnumbers.
                </para>
            </section>

            <section role="NotInToc">
                <title>記事データのリストア</title>

                <para>
                    If you configured OTRS to store article data in the filesystem you have to
restore the <filename>article</filename> folder to
<filename>/opt/otrs/var/</filename>.
                </para>
            </section>

            <section role="NotInToc">
                <title>Set file permissions</title>

                <para>
                Please execute <screen><![CDATA[
shell> cd /opt/otrs/
shell> bin/otrs.SetPermissions.pl
                ]]></screen> with the permissions
needed for your system setup. For example:

                <itemizedlist>
                <listitem>
                    <para>Web server which runs as the OTRS user: <screen><![CDATA[
shell> bin/otrs.SetPermissions.pl --web-group=otrs
                ]]></screen>
                    </para>
                </listitem>


                <listitem>
                    <para>Webserver with wwwrun user (e. g. SUSE): <screen><![CDATA[
shell> bin/otrs.SetPermissions.pl --web-group=wwwrun
                ]]></screen>
                    </para>
                </listitem>


                <listitem>
                    <para>Webserver with apache user (e. g. Red Hat, CentOS): <screen><![CDATA[
shell> bin/otrs.SetPermissions.pl --web-group=apache
                ]]></screen>
                    </para>
                </listitem>


                <listitem>
                    <para>Webserver with www-data user (e. g. Debian, Ubuntu): <screen><![CDATA[
shell> bin/otrs.SetPermissions.pl --web-group=www-data
                ]]></screen>
                    </para>
                </listitem>
                </itemizedlist>

                </para>
            </section>
        </section>

        <section role="NotInToc">
            <title>Step 4.2: With the RPM:</title>
            <para>
            <screen><![CDATA[
shell> rpm -Uvh otrs-x.x.x.-01.rpm
            ]]></screen> In this case the RPM update
automatically restores the old configuration files and sets file
permissions.
            </para>
        </section>
    </section>

    <section role="NotInToc">
        <title>Step 5: Check needed Perl modules</title>

        <para>
        システムに必要とされるperlモジュールがすべてインストールされ不足しているおそれのあるモジュールをインストールすることを確認してください。<screen><![CDATA[
shell> /opt/otrs/bin/otrs.CheckModules.pl
        ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 6: Apply the database changes</title>

        <section role="NotInToc">
            <title>Step 6.1: Database schema update</title>

            <section role="NotInToc">
            <title>MySQL:</title>

                <para>
                Note: new tables created in the MySQL UPGRADING process will be created with
the default table storage engine set in your MySQL server.  In MySQL 5.5 the
new default type is <code>InnoDB</code>.  If existing tables, e.g. "users",
have the table storage engine e.g. <code>MyISAM</code>, then an error will
be displayed when creating the foreign key constraints.
                </para>

                <para>
                You have two options: you can change the default storage engine of MySQL
back to <code>MyISAM</code> so that new tables will have the same engine as
the existing tables, or change the existing tables to use InnoDB as storage
engine.
                </para>

                <para>
                Any problems with regards to the storage engine will be reported by the
<filename>otrs.CheckDB.pl</filename> script, so please run it to check for
possible issues.  <screen><![CDATA[
shell> cd /opt/otrs/
shell> bin/otrs.CheckDB.pl
shell> cat scripts/DBUpdate-to-4.mysql.sql | mysql -p -f -u root otrs
                ]]></screen>

                </para>

            </section>
            <section role="NotInToc">
                <title>PostgreSQL:</title>

                <para>
                <screen><![CDATA[
shell> cd /opt/otrs/
shell> cat scripts/DBUpdate-to-4.postgresql.sql | psql --set ON_ERROR_STOP=on --single-transaction otrs otrs
                ]]></screen>
                </para>
            </section>
        </section>

        <section role="NotInToc">
            <title>Step 6.2: Database migration script</title>

            <para>
            Run the migration script (as user <code>otrs</code>, NOT as
<code>root</code>): <screen><![CDATA[
shell> scripts/DBUpdate-to-4.pl
            ]]></screen> Do not continue the
upgrading process if this script did not work properly for you.  Otherwise
data loss may occur.
            </para>
        </section>
    </section>

    <section role="NotInToc">
        <title>Step 7: Own themes</title>

        <para>
        Note: The OTRS themes of 3.3 are NOT compatible with OTRS 4, so don't use
your old themes!
        </para>

        <para>
        Themes are located under
<filename>/opt/otrs/Kernel/Output/HTML/*/*.tt</filename>.
        </para>

        <para>
        Please note that OTRS 4 comes with a new templating engine based on <ulink
url="http://www.template-toolkit.org">Template::Toolkit</ulink>. All
customized templates must be converted from DTL to the new format. Please
see <ulink
url="http://otrs.github.io/doc/manual/developer/4.0/en/html/package-porting.html#package-porting-template-engine">the
development manual</ulink> for detailed instructions.
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 8: Refresh the configuration cache and delete caches</title>

        <para>
        Please run (as user <code>otrs</code>, <emphasis>not</emphasis> as
<code>root</code>): <screen><![CDATA[
shell> bin/otrs.RebuildConfig.pl
shell> bin/otrs.DeleteCache.pl
        ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 9: Restart your services</title>

        <para>
        例えば（ご使用中のサービスによりますが）<screen><![CDATA[
shell> /etc/init.d/apache start
shell> /etc/init.d/postfix start
shell> /etc/init.d/cron start
        ]]></screen>今、システムにログインできます。
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 10: Check installed packages</title>

        <notice>
            The OTRS packages of 3.3 are NOT compatible with OTRS 4, so you have to
perform a package upgrade!
        </notice>

        <para>
        以下のパッケージはアップグレード・プロセス後。自動的にアンインストールされます（先にインストール済ならば）

            <itemizedlist>
                <listitem><para>OTRSGenericInterfaceREST</para></listitem>
                <listitem><para>OTRSMyServices</para></listitem>
                <listitem><para>OTRSStatsRestrictionByDateTimeDF</para></listitem>
                <listitem><para>Support</para></listitem>
            </itemizedlist>
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 11: Check GenericAgent jobs</title>

        <para>
            If you have any GenericAgent jobs (or even any custom developments)  that
automatically set ProcessID or ActivityID dynamic fields, you need to update
these to set the fields to the new long EntityIDs that were generated by
<filename>DBUpdate-to-4.pl</filename>.
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 12: Update and activate cronjobs</title>

        <para>
            There are several OTRS default cronjobs in
<filename>/opt/otrs/var/cron/*.dist</filename>.  They can be activated by
copying them without the ".dist" filename extension.  Do this to make sure
you get the latest versions of the cronjobs and new cronjobs as well.
<screen><![CDATA[
shell> cd /opt/otrs/var/cron
shell> for foo in *.dist; do cp $foo `basename $foo .dist`; done
            ]]></screen> Please check the copied files and
re-apply any customizations that you might have made.  To schedule these
cronjobs on your system, you can use the script
<filename>Cron.sh</filename>.  Make sure to execute it as the
<code>otrs</code> user! <screen><![CDATA[
shell&gt; /opt/otrs/bin/Cron.sh start
            ]]></screen>
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 13: Update Customer database configuration</title>

        <para>
        If you're using an external customer database and this database does NOT
provide the OTRS specific fields create_time, create_by, change_time and
change_by, please set <code>ForeignDB => 1</code> for
<code>$Self->{CustomerUser}</code> and <code>$Self->{CustomerCompany}</code>
(see <filename>Kernel/Config/Defaults.pm</filename>).
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 14: Rebuild Ticket index</title>

        <para>
        Please run <filename>bin/otrs.RebuildTicketIndex.pl</filename> to regenerate
the ticket index.  This can be done in the background to calculate the
ticket numbers for the queue view screens.  You can already use your system.
        </para>
    </section>

    <section role="NotInToc">
        <title>Step 14: Well done!</title>
        <para></para>
    </section>

</section>
