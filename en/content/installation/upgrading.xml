<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
  "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">

<section id="upgrading">
    <title>Upgrading OTRS from 3.3 to 4</title>

    <para>
    These instructions are for people upgrading OTRS from <emphasis>3.3</emphasis> to <emphasis>4</emphasis>
    or from a <emphasis>4</emphasis> to a later patchlevel release <emphasis>4</emphasis> and applies both for RPM
    and source code (tarball) upgrades.
    </para>

    <para>
    If you are running a lower version of OTRS you have to follow the upgrade path
    to 3.3 first (1.1->1.2->1.3->2.0->2.1->2.2->2.3->2.4->3.0->3.1->3.2->3.3)!
    You need to perform a full upgrade to every version in between, including
    database changes and the upgrading perl script.
    </para>

    <para>
    Please note that if you upgrade from OTRS 2.2 or earlier, you have to
    take <ulink url="http://bugs.otrs.org/show_bug.cgi?id=6798">an extra step</ulink>.
    </para>

    <para>
    Within a single minor version you can skip patch level releases if you want to
    upgrade. For instance you can upgrade directly from OTRS 4 patchlevel 2 to version
    4 patchlevel 6. If you need to do such a "patch level upgrade", you should skip steps
    6, 12 and 13.
    </para>

    <para>
    It is highly recommended to perform a test update on a separate testing machine first.
    </para>

    <section>
        <title role="NotInToc">1. Stop all relevant services</title>

        <para>
        Please make sure there are no more running services or cronjobs that try to access OTRS.
        This will depend on your service configuration, here is an example:

            <programlisting><![CDATA[
shell> /etc/init.d/cron stop
shell> /etc/init.d/postfix stop
shell> /etc/init.d/apache stop
            ]]></programlisting>

        Stop OTRS cronjobs and the scheduler (in this order):

            <programlisting><![CDATA[
shell> cd /opt/otrs/
shell> bin/Cron.sh stop
shell> bin/otrs.Scheduler.pl -a stop
            ]]></programlisting>
        </para>
    </section>

    <section>
        <title role="NotInToc">2. Backup everything below <filename>/opt/otrs/</filename></title>

        <para>
            <itemizedlist>
                <listitem><para><filename>Kernel/Config.pm</filename></para></listitem>
                <listitem><para><filename>Kernel/Config/GenericAgent.pm</filename></para></listitem>
                <listitem><para><filename>Kernel/Config/Files/ZZZAuto.pm</filename></para></listitem>
                <listitem><para><filename>var/*</filename></para></listitem>
                <listitem><para>as well as the database</para></listitem>
            </itemizedlist>
        </para>
    </section>

    <section>
        <title role="NotInToc">3. Make sure that you have backed up everything ;-)</title>
        <para></para>
    </section>

    <section>
    <title role="NotInToc">4. Install the new release (tar or RPM)</title>

        <section>
        <title role="NotInToc">4.1 With the tarball:</title>

            <programlisting><![CDATA[
shell> cd /opt
shell> mv otrs otrs-old
shell> tar -xzf otrs-x.x.x.tar.gz
shell> mv otrs-x.x.x otrs
            ]]></programlisting>

            <section>
            <title role="NotInToc">Restore old configuration files</title>

                <para>
                    <itemizedlist>
                        <listitem><para><filename>Kernel/Config.pm</filename></para></listitem>
                        <listitem><para><filename>Kernel/Config/GenericAgent.pm</filename></para></listitem>
                        <listitem><para><filename>Kernel/Config/Files/ZZZAuto.pm</filename></para></listitem>
                    </itemizedlist>
                </para>
            </section>

            <section>
                <title role="NotInToc">Restore TicketCounter.log</title>

                <para>
                    In order to let OTRS continue with the correct ticket number, restore the <filename>TicketCounter.log</filename> to
                    <filename>/opt/otrs/var/log/</filename>. This is especially important if you use incremental ticketnumbers.
                </para>
            </section>

            <section>
                <title role="NotInToc">Restore article data</title>

                <para>
                    If you configured OTRS to store article data in the filesystem you have to restore the <filename>article</filename> folder to <filename>/opt/otrs/var/</filename>.
                </para>
            </section>

            <section>
                <title role="NotInToc">Set file permissions</title>

                <para>
                Please execute

                <programlisting><![CDATA[
shell> cd /opt/otrs/
shell> bin/otrs.SetPermissions.pl
                ]]></programlisting>

                with the permissions needed for your system setup. For example:

                <itemizedlist>
                <listitem>
                    <para>Web server which runs as the OTRS user:
                <programlisting><![CDATA[
shell> bin/otrs.SetPermissions.pl --otrs-user=otrs --web-user=otrs /opt/otrs
                ]]></programlisting>
                    </para>
                </listitem>


                <listitem>
                    <para>Webserver with wwwrun user (e. g. SUSE):
                <programlisting><![CDATA[
shell> bin/otrs.SetPermissions.pl --otrs-user=otrs --web-user=wwwrun /opt/otrs
                ]]></programlisting>
                    </para>
                </listitem>


                <listitem>
                    <para>Webserver with apache user (e. g. Red Hat, CentOS):
                <programlisting><![CDATA[
shell> bin/otrs.SetPermissions.pl --otrs-user=otrs --web-user=apache --otrs-group=apache --web-group=apache /opt/otrs
                ]]></programlisting>
                    </para>
                </listitem>


                <listitem>
                    <para>Webserver with www-data user (e. g. Debian, Ubuntu):
                <programlisting><![CDATA[
shell> bin/otrs.SetPermissions.pl --otrs-user=otrs --web-user=www-data --otrs-group=www-data --web-group=www-data /opt/otrs
                ]]></programlisting>
                    </para>
                </listitem>
                </itemizedlist>

                </para>
            </section>
        </section>

        <section>
            <title role="NotInToc">4.2 With the RPM:</title>
            <para>
            <programlisting><![CDATA[
shell> rpm -Uvh otrs-x.x.x.-01.rpm
            ]]></programlisting>

            In this case the RPM update automatically restores the old configuration files and sets file permissions.
            </para>
        </section>
    </section>

    <section>
        <title role="NotInToc">5. Check needed Perl modules</title>

        <para>
        Verify that all needed perl modules are installed on your system and install
        any modules that might be missing.
        <programlisting><![CDATA[
shell> /opt/otrs/bin/otrs.CheckModules.pl
        ]]></programlisting>
        </para>
    </section>

    <section>
        <title role="NotInToc">6. Apply the database changes</title>

        <section>
            <title role="NotInToc">6.1 Database schema update</title>

            <section>
            <title role="NotInToc">MySQL:</title>

                <para>
                Note: new tables created in the MySQL UPGRADING process will be created with the
                default table storage engine set in your MySQL server.
                In MySQL 5.5 the new default type is <code>InnoDB</code>.
                If existing tables, e.g. "users", have the table storage engine e.g. <code>MyISAM</code>,
                then an error will be displayed when creating the foreign key constraints.
                </para>

                <para>
                You have two options: you can change the default storage engine of MySQL back to <code>MyISAM</code>
                so that new tables will have the same engine as the existing tables,
                or change the existing tables to use InnoDB as storage engine.
                </para>

                <para>
                Any problems with regards to the storage engine will be reported by the
                <filename>otrs.CheckDB.pl</filename> script, so please run it to check for possible issues.

                <programlisting><![CDATA[
shell> cd /opt/otrs/
shell> bin/otrs.CheckDB.pl
shell> cat scripts/DBUpdate-to-4.mysql.sql | mysql -p -f -u root otrs
                ]]></programlisting>

                </para>

            </section>
            <section>
                <title role="NotInToc">PostgreSQL:</title>

                <para>
                <programlisting><![CDATA[
shell> cd /opt/otrs/
shell> cat scripts/DBUpdate-to-4.postgresql.sql | psql --set ON_ERROR_STOP=on --single-transaction otrs otrs
                ]]></programlisting>
                </para>
            </section>
        </section>

        <section>
            <title role="NotInToc">6.2 Database migration script</title>

            <para>
            Run the migration script (as user <code>otrs</code>, NOT as <code>root</code>):

            <programlisting><![CDATA[
shell> scripts/DBUpdate-to-4.pl
            ]]></programlisting>

            Do not continue the upgrading process if this script did not work properly for you.
            Otherwise data loss may occur.
            </para>
        </section>
    </section>

    <section>
        <title role="NotInToc">7. Own themes</title>

        <para>
        Note: The OTRS themes of 3.3 are NOT compatible with OTRS 4, so don't use your old themes!
        </para>

        <para>
        Themes are located under <filename>/opt/otrs/Kernel/Output/HTML/*/*.tt</filename>.
        </para>

        <para>
        Please note that OTRS 4 comes with a new templating engine based on
        <ulink url="http://www.template-toolkit.org">Template::Toolkit</ulink>. All customized templates must be converted from
        DTL to the new format. Please see
        <ulink url="http://otrs.github.io/doc/manual/developer/4.0/en/html/package-porting.html#package-porting-template-engine">the development manual</ulink>
        for detailed instructions.
        </para>
    </section>

    <section>
        <title role="NotInToc">8. Refresh the configuration cache and delete caches</title>

        <para>
        Please run (as user <code>otrs</code>, <emphasis>not</emphasis> as <code>root</code>):

        <programlisting><![CDATA[
shell> bin/otrs.RebuildConfig.pl
shell> bin/otrs.DeleteCache.pl
        ]]></programlisting>
        </para>
    </section>

    <section>
        <title role="NotInToc">9. Restart your services</title>

        <para>
        e. g. (depends on used services):

        <programlisting><![CDATA[
shell> /etc/init.d/apache start
shell> /etc/init.d/postfix start
shell> /etc/init.d/cron start
        ]]></programlisting>

        Now you can log into your system.
        </para>
    </section>

    <section>
        <title role="NotInToc">10. Check installed packages</title>

        <para>
        In the package manager, check if all packages are still marked as
        correctly installed or if any require reinstallation or even a package upgrade.
        </para>

        <para>
        The following packages are automatically uninstalled after the upgrade process (if they where
        installed before):

            <itemizedlist>
                <listitem><para>OTRSGenericInterfaceREST</para></listitem>
                <listitem><para>OTRSMyServices</para></listitem>
                <listitem><para>OTRSStatsRestrictionByDateTimeDF</para></listitem>
                <listitem><para>Support</para></listitem>
            </itemizedlist>
        </para>
    </section>

    <section>
        <title role="NotInToc">11. Update and activate cronjobs</title>

        <para>
            There are several OTRS default cronjobs in <filename>/opt/otrs/var/cron/*.dist</filename>.
            They can be activated by copying them without the ".dist" filename extension.
            Do this to make sure you get the latest versions of the cronjobs and new cronjobs
            as well.

            <programlisting><![CDATA[
shell> cd /opt/otrs/var/cron
shell> for foo in *.dist; do cp $foo basename $foo .dist`; done
            ]]></programlisting>

            Please check the copied files and re-apply any customizations that you might have made.

            To schedule these cronjobs on your system, you can use the script <filename>Cron.sh</filename>.
            Make sure to execute it as the <code>otrs</code> user!

            <programlisting><![CDATA[
shell> /opt/otrs/bin/Cron.sh start
            ]]></programlisting>
        </para>
    </section>

    <section>
        <title role="NotInToc">12. Update Customer database configuration</title>

        <para>
        If you're using an external customer database and this database does NOT provide the OTRS specific fields
        create_time, create_by, change_time and change_by, please set <code>ForeignDB => 1</code>
        for <code>$Self->{CustomerUser}</code> and <code>$Self->{CustomerCompany}</code>
        (see <filename>Kernel/Config/Defaults.pm</filename>).
        </para>
    </section>

    <section>
        <title role="NotInToc">13. Rebuild Ticket index</title>

        <para>
        Please run <filename>bin/otrs.RebuildTicketIndex.pl</filename> to regenerate the ticket index.
        This can be done in the background to calculate the ticket numbers for the queue view screens.
        You can already use your system.
        </para>
    </section>

    <section>
        <title role="NotInToc">14. Well done!</title>
        <para></para>
    </section>

</section>
