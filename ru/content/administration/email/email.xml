<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
  "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">

<section id="email">
<title>Отправка / получение электронной почты</title>

<section id="email-sending">
<title>Отправка почты</title>

<section id="email-sending-sendmail">
<title>через Sendmail (по умолчанию)</title>

<para>
OTRS может отправлять сообщения электронной почты через <ulink
url="http://www.sendmail.org/">Sendmail</ulink>, <ulink
url="http://www.postfix.org/">Postfix</ulink>, <ulink
url="http://www.qmail.org">Qmail</ulink> or <ulink
url="http://www.exim.org">Exim</ulink>). По умолчанию используется Sendmail,
он должен работать при установки системы "из коробки".
</para>

<para>
Параметры sendmail можно настроить через графический веб-интерфейс для
конфигурации (Framework::Core::Sendmail)
</para>

</section>

<section id="email-sending-smtp">
<title>Через SMTP-сервер или smarthost</title>

<para>
OTRS может посылать письма через SMTP (<ulink
url="http://www.ietf.org/rfc/rfc821.txt">Simple Mail Transfer Protocol / RFC
821</ulink>) или Secure SMTP.
</para>

<para>
Параметры настройки SMTP-сервера могут быть сконфигурированны через
SysConfig (Framework::Core::Sendmail). Если у вас нету SMTPS в качестве
опции, значит вы пропустили установку соответствующих Perl-модулей. В таком
случае, обратитесь пожалуйста к этой <link
linkend="installation-of-perl-modules">"Установка Perl-модулей необходимых
для работы OTRS"</link> инструкции.
</para>

</section>

</section>

<section id="email-receiving">
<title>Получение сообщений электронной почты</title>

<section id="email-receiving-pop3">
<title>Учетные записи электронной почты настраиваемые через графический
пользовательский интерфейс OTRS</title>

<para>
OTRS позволяет получать сообщения электронной почты через почтовые аккаунты
POP3, POP3S, IMAP, и IMAPS.
</para>

<para>
Для настройки почтовых аккаунтов воспользуйтесь ссылкой "Почтовые Аккаунты
PostMaster" на странице администрирования.
</para>

<para>
Если создан новый почтовый аккаунт/ящик (см. нижеприведенный сценарий), то
нужно еще указать имя его почтового сервера, логин и пароль. Также,
необходимо выбрать тип почтового сервера: POP3, POP3S, IMAP или IMAPS. Если
в опциях не видно типа сервера, который нужно использовать, значит вы не
установили в системе все необходимые Perl-модули. В таком случае, за более
подробной информацией обратитесь к инструкции <link
linkend="installation-of-perl-modules"> "Установка Perl-модулей, необходимых
для работы OTRS"</link>.</para>

<para>
<screenshot>
<screeninfo>Добавление учетной записи электронной почты</screeninfo> <graphic srccredit="Adminarea
postmaster - screenshot" scale="40"
fileref="screenshots/add-mailaccount.png"></graphic></screenshot>
</para>

<para>
<emphasis>Рисунок Добавление учетной записи электронной почты.</emphasis>
</para>

<para>Если для опции "Trusted" выбрано значение "Да", будут оцениваться и
выполнятся любые X-OTRS-заголовки, присоединенные к входящему
сообщению. Поскольку X-OTRS-заголовок может выполнять некоторые действия в
системе обработки заявок, то для извесных отправителей опцию Trusted нужно
установить только в значение Да. X-OTRS-заголовки используюся в OTRS <link
linkend="adminarea-postmasterfilter"> модулем фильтрации </link>. Более
подробно X-OTRS заголовки рассматриваются в <link
linkend="table-of-x-otrs-headers">этой таблице</link>. Любые созданные и
выполненные правила фильтрации независимы от параметров настроки Trusted.
</para>

<para>
Можно контролировать распределением входящих сообщений, если они должны
сортироваться по очередям или содержимому поля "Кому". Если для
Диспетчеризации выбрана опция "Диспетчеризация по выбранной очереди", то все
входящие сообщения будут отсортированы в указанной очереди. В таком случае
адрес, с которого отправили сообщение не учитывается. Если для
диспетчеризации выбрана опция "Диспетчеризация писем по полю Кому", система
для входящих писем проверяет, связана ли эта очередь с адресом электронной
почты в поле Кому. Перейдя по ссылке <link
linkend="adminarea-emailaddresses">Управление E-mail-адресами</link> в
Панели Администрирования, можно связать определенный адрес с очередью. Если
не найдено никакой связи между адресом в поле "Кому" то сообщение будет
сохранятся в системе в очереди "Raw" , которая задана в <link
linkend="ConfigReference_Ticket:Core::PostMaster:PostmasterDefaultQueue">
PostmasterDefaultQueue </link> по умолчанию после установки системы.
</para>

<para>
Все данные для учетных записей электронной почты сохраняются в базе данных
OTRS. Скрипт <filename>otrs.PostMasterMailbox.pl</filename>, который
находится в директории <filename>bin</filename> вашей системы OTRS,
использует настройки в базе данных и получает почту. Вы можете выполнить
файл <filename>./bin/otrs.PostMasterMailbox.pl</filename> вручную чтобы
проверить что все ваши настройки почты работают правильно.
</para>

<para>
On a normal installation, the mail will be fetched every 10 minutes by the
OTRS Daemon.
</para>

<note>
<para>
При получении почты OTRS удаляет почту с POP или IMAP сервера. Нету такой
опции,  которая бы позволяла хранить копию сообщения на сервере. Если вы все
же хотите чтобы такая возможность присутствовала, скорей всего нужно
воспользоваться правилами переадресации на почтовый сервер. Оратитесь
пожалуйста к документации по вашему почтовому серверу.
</para>
</note>
</section>


<section id="email-receiving-cmd">
<title>Через командную строку программы и например, procmail (otrs.PostMaster.pl)</title>

<para>
Если для получения электронной почты в OTRS нету возможности использовать
учетные записи, то эту проблему можно решить с помощью программы командной
строки <filename>bin/otrs.PostMaster.pl</filename>Она принимает сообщения
электронной почты через STDIN и направляет их непосредственно в OTRS. Это
значит что емейлы будут доступны в OTRS когда MDA (Mail Delivery Agent -
Агент доставки почты) выполняет эту программу.
</para>

<para>
Для тестирования <filename>bin/otrs.PostMaster.pl</filename> без MDA,
выполните команду приведенную в листинге нижеприведенного сценария.
</para>

<para>
<screen>
linux:/opt/otrs# cd bin
linux:/opt/otrs/bin# cat ../doc/sample_mails/test-email-1.box | ./otrs.PostMaster.pl
linux:/opt/otrs/bin#
</screen>
</para>

<para>
<emphasis>Сценарий: Тестирование PostMaster без MDA.</emphasis>
</para>

<para>
Если сообщения электронной почты отображаются в QueueView, значит вашы
настройки работают.
</para>

<para>
Procmail - это очень распостраненный фильтр электронной почты в среде
Linux.  Он устанавливается на большинстве систем. Если нет, перейдите по
ссылке <ulink url="http://www.procmail.org/"><citetitle>procmail
homepage</citetitle></ulink>.
</para>

<para>
Для настройки procmail для OTRS (требуется сконфигурированный транспортный
агент MTA, например sendmail, postfix, exim or qmail), используйте файл
<filename>~otrs/.procmailrc.dist</filename>, скопируйте его в
<filename>.procmailrc</filename> а затем добавьте строки из нижеприведенного
сценария.
</para>

<para>
<programlisting>
SYS_HOME=$HOME
PATH=/bin:/usr/bin:/usr/local/bin
# --
# Pipe all email into the PostMaster process.
# --
:0 :
| $SYS_HOME/bin/otrs.PostMaster.pl
</programlisting>
</para>

<para>
<emphasis>Сценарий: Настройка procmail для OTRS.</emphasis>
</para>

<para>
Все емейлы отсылаемые локальному OTRS-пользователю будут обрабатываться
<filename>bin/otrs.PostMaster.pl</filename> и потом отображаться в
QueueView.
</para>

</section>

<section id="email-receiving-fetchmail">
<title>Получение электронной почты по протоколу POP3 или IMAP и обработка для
otrs.PostMaster.pl</title>

<para>
Для того чтобы получить электронную почту с вашего почтового сервера через
POP3 или IMAP и сохранить ее на компьютере на котором установлен OTRS, для
локального аккаунта или в procmail, перейдите по ссылке <ulink
url="http://fetchmail.berlios.de/">fetchmail</ulink>.
</para>

<note>
<para>
Работающий и сконфигурированный SMTP необходим для работы OTRS.
</para>
</note>

<para>
Можно использовать файл <filename>.fetchmailrc.dist</filename> в домашней
директории OTRS и скопировать его в
<filename>.fetchmailrc</filename>. Изменить его в соответствии с вашими
требованиями (см. ниже Пример 7-1).
</para>

<example id='fetchmailrc'>
<title>.fetchmailrc</title>

<para>
<programlisting>
#poll (mailserver) protocol POP3 user (user) password (password) is (localuser)
poll mail.example.com protocol POP3 user joe password mama is otrs
</programlisting>
</para>

</example>

<para>
Не забудьте установить.fetchmailrc to 710 ("chmod 710 .fetchmailrc")!
</para>

<para>
Из Листинга 7-1 выше, <filename>.fetchmailrc</filename> , все емейлы будут
перенаправлены в локальный OTRS-аккаунт, если выполнена команда
<command>fetchmail -a</command>. Установите эту команду в планировщике задач
cronjob если хотите извлекать емейлы постоянно.
</para>
</section>


<section id="email-receiving-filter">
<title>Фильтрация/рассылка модулями OTRS/PostMaster (для более сложной
диспетчеризации)</title>

<para>
Если вы используете метод bin/otrs.PostMaster.pl или
bin/otrs.PostMasterMailbox.pl, то с модулем фильтрации PostMaster можно
вставить или модифицировать X-OTRS заголовок. С помощью X-OTRS-заголовков,
система обработки заявок может вызывать некоторые действия для входящих
сообщений, сортировать их в определенные очереди, или, например, изменять
приоритет или ID-клиента. Более подробную информацию о X-OTRS-заголовках
можно найти в главе <link linkend="adminarea-postmasterpop3-account">
добавление аккаунтов электронной почты </link> в Панели Администрирования.
</para>

<para>
Есть некоторые предустановленные модули фильтрации:
</para>

<note>
<para>
Название задания (например
$Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'JobName'}) должно быть
уникальным!
</para>
</note>

<para>
Kernel::System::PostMaster::Filter::Match модуль по умолчанию для проверки
совпадения заголовков определенных емейлов (например "От", "Кому", "Тема",
...). Он может устанавливать новые заголовки email (например X-OTRS-Ignore:
да или X-OTRS-Queue: spam) если совпадают правила совпадения. Задания из
Примера 7-2 могут быть прописаны в <filename>Kernel/Config.pm</filename>
</para>

<example id='filter-module-match-example'>
<title>Пример задания для модуля фильтрации
Kernel::System::PostMaster::Filter::Match</title>

<para>
<programlisting>
    # Job Name: 1-Match
    # (block/ignore all spam email with From: noreply@)
    $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'1-Match'} = {
        Module =&gt; 'Kernel::System::PostMaster::Filter::Match',
        Match =&gt; {
            From =&gt; 'noreply@',
        },
        Set =&gt; {
            'X-OTRS-Ignore' =&gt; 'yes',
        },
    };
    # Job Name: 2-Match
    # (sort emails with From: sales@example.com and Subject: **ORDER**
    # into queue 'Order')
    $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'2-Match'} = {
        Module =&gt; 'Kernel::System::PostMaster::Filter::Match',
        Match =&gt; {
            To =&gt; 'sales@example.com',
            Subject =&gt; '**ORDER**',
        },
        Set =&gt; {
            'X-OTRS-Queue' =&gt; 'Order',
        },
    };
</programlisting>
</para>

</example>

<para>
Kernel::System::PostMaster::Filter::CMD модуль по умолчанию для получения
емейлов для внешних команд. Вывод передается в STDOUT и если результат
истинна, то устанавливается новый заголовок (например X-OTRS-Ignore: да или
X-OTRS-Queue: spam). Пример 7-3 может быть использован в
<filename>Kernel/Config.pm</filename>
</para>

<example id='filter-module-cmd-example'>
<title>Пример задания для модуля фильтрации Kernel::System::PostMaster::Filter::CMD</title>

<para>
<programlisting>
    # Job Name: 5-SpamAssassin
    # (SpamAssassin example setup, ignore spam emails)
    $Self-&gt;{'PostMaster::PreFilterModule'}-&gt;{'5-SpamAssassin'} = {
        Module =&gt; 'Kernel::System::PostMaster::Filter::CMD',
        CMD =&gt; '/usr/bin/spamassassin | grep -i "X-Spam-Status: yes"',
        Set =&gt; {
            'X-OTRS-Ignore' =&gt; 'yes',
        },
    };
</programlisting>
</para>

</example>

<para>
    Kernel::System::PostMaster::Filter::ExternalTicketNumberRecognition это
модуль по умолчанию, который дает возможность разбора/парсинга внешних
идентификаторов в теме письма, в его теле или в обоих полях с помощью
регулярных выражений. Затем результат разбора сохраняется в заданном
динамическом поле. При поступлении письма, OTRS сначала отыскивает внешний
идентификатор и, при нахождении, запрашивает OTRS о заранее заданном
значении динамического поля. Если найдена существующая заявка, она
обновляется, в противном случае создается новая заявка со ссылкой на внешний
номер в отдельном поле.
</para>
<para>
    OTRS SysConfig предлагает 4 разных варианта настройки внешних номеров
заявки. Если требуются другие варианты, они должны быть добавлены
вручную. Следующий пример может быть использован  для расширения имеющихся
настроек в <filename>Kernel/Config.pm</filename>.
</para>

<example id='filter-module-externalticketrecognition-example'>
    <title>
        Пример задания для модуля фильтрации
Kernel::System::PostMaster::Filter::ExternalTicketNumberRecognition
    </title>

<programlisting language="Perl"><![CDATA[
    # Job Name: ExternalNumber
    # External Ticket Number Reconition, check for Incident-<number> in incoming mails subject and
    # body from the addeesses <sender>@externalticket.com, if number is found it will be stored in
    # the dynamic field 'ExternalNumber' (that need to be setup in the Admin Panel).
    $Self->{'PostMaster::PreFilterModule'}->{'000-ExternalTicketNumberRecognition5'} =  {
        'FromAddressRegExp' => '\\s*@externalticket.com',
        'NumberRegExp'      => 'Incident-(\\d.*)',
        'SearchInSubject'   => '1',
        'SearchInBody'      => '1',
        'TicketStateTypes'  => 'new;open'
        'DynamicFieldName'  => 'ExternalNumber',
        'Module'            => 'Kernel::System::PostMaster::Filter::ExternalTicketNumberRecognition',
        'Name'              => 'Test External Ticket Number',
        'SenderType'        => 'system',
    };
    ]]></programlisting></example>

<itemizedlist mark="round">
    <para><emphasis>Параметры конфигурации</emphasis></para>
    <listitem>
        <para>FromAddressRegExp</para>
        <para>
            Это настройка необязательна. Только писма с заданным значением поля "From:"
будут рассмотрены этим фильтром. Вы можете изменить эту настройку  на адрес
отправителя вашей внешней системы, используемой для исходящей почты. В
случае, если адреса различны, вы можете оставить этот параметр пустым. Тогда
OTRS не будет проверять адрес отправителя.
        </para>
    </listitem>
    <listitem>
        <para>NumberRegExp</para>
        <para>
            Этщт параметр обязателен. Он содержит регулярное выражение, которое OTRS
будет использовать для извлечения номера заявки из темы и/или тела
письма. Выражение по умолчанию будет проверять соответствие, например,
'Incident-12354' и помещать часть значения между скобками в динамическое
поле, в данном случае '12354'.
        </para>
    </listitem>
    <listitem>
        <para>SearchInSubject</para>
        <para>Если установлено в '1', в поле Тема письма будет осуществляться поиск номера
заявки.</para>
    </listitem>
    <listitem>
        <para>SearchInBody</para>
        <para>Если установлено в '1', поиск номера заявки будет осуществляться в тексте
письма.</para>
    </listitem>
    <listitem>
        <para>TicketStateTypes</para>
        <para>
            Это необязательный параметр. Если задан, OTRS будет искать отерытые внешние
заявки с заданными типами состояний. Типы состояний в списке разделяются
точкой с запятой.
        </para>
    </listitem>
    <listitem>
        <para>DynamicField</para>
        <para>
            Обязательный параметр. Задает динамическое поле, используемое для хранения
внешнего номера заявки (имя поля должно существовать в системе и быть
действительным).
        </para>
    </listitem>
    <listitem>
        <para>SenderType</para>
        <para>Этот параметр задает тип отправителя и используется при создании
сообщений/заметок в OTRS.</para>
    </listitem>
</itemizedlist>

<para>
Конечно, также есть возможность разработки своих собственных
PostMaster-модулей фильтрации.
</para>

</section>

</section>

</section>
